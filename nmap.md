# How to use Nmap

## Port Scanning

```
# Stealthy
nmap -sS 192.168.1.1

# Scan all ports might take a while
nmap 192.168.1.1 -p-

# Scan for UDP
nmap -sU 192.168.1.1
unicornscan -mU -v -I 192.168.1.1

# Scan for version, with NSE scripts and try to identify OS
nmap -sV -sC -O 192.168.1.1

# All out scan
nmap -vvv -Pn -A -iL listofIP.txt

# Fast Scan
nmap 192.168.1.1 -F

# Only Scan Top 100 Ports
nmap 192.168.1.1 --top-ports 100
```

### Nmap Options

```
# very verbose
-vv 

# Skip ports
-sn
```

### Timing and agressiveness

```
# Paranoid Scan
T0 

# Sneaky Scan
T1

# Polite Scan
T2

# Normal Scan 
T3

# Agressive Scan
T4

# Insane Scan
T5

#example

nmap -T5 192.168.1.1
```
### What to do...

Now that you have gathered some IP addresses from your subdomain discovery it is time to scan them. You can copy-paste those IPs
into a file line by line. Then you scan them with nmap at the same time.
```
-iL # input list

nmap 192.168.1.1 -iL listofip.txt
```

## How a TCP-connect scan works

When one machine initiates a connection with another machine using the **transmission-control-protocol (TCP)** it performs what 
is known as a three way handshake, this means :

```
SYN = Synchronize
ACK = Acknowledge
```

```
machine1 sends syn packet to machine2
machine2 sends a syn-ack packet to machine1
machine1 sends a ack packet to machine2
```

if machine2 responds with a SYN-ACK packet, we know that the port is open. This is basically what nmap does when it
scans for a port

This is the default mode for Nmap, if know flags were added this is the type of connection it makes

### Stealthy Scans -sS

By adding ```-sS``` flag we are telling nmap not to finalize the three way handshake.
```
attacker sends a SYN to the target
target replies with a SYN-ACK
session terminated
```
This used to be considered stealty, because it does not get logged. However it shouldn't be considered stealthy anymore

### UDP Scans

UDP is after TCP as the most common protocol. DNS(53), SNMP(161/162), DHCP(67/68) are some of the common ones
scanning for it is slow and unreliable
```
-sU
```

### Output scans to a text file

Output to text file (.txt)
```
-oN filename
```

Output to grepable format
```
-oG filename
```

Output to XML
```
-oX filename
```

Output to **all** formats
```
-oA filename
```

### Scanning an IP range

Scanning all the **entire IP**
```
nmap 192.168.1.1/24
```

the ```-sn``` flag stops nmap from running port scans. So it speeds up the process

**Specifying IP ranges**

```
nmap 192.168.1.1-100
```

## Nmap Scripts
This can be useful to retrieve information that can be useful in the process to find vulnerabilities

1. Locate all the nmap scripts. 
```
locate *.nse
```

2. Syntax for running a script

```
nmap --script scriptname.nse 192.168.1.1
```

3. To find the man pages for an NSE script
```
nmap -script-help scriptname.nse
```

4. Running multiple scripts at once
```
nmap --script scriptname1.nse, scriptname2.nse, scriptname3.nse 192.168.1.1
```

5. Running the default script
```
nmap -sC example.com
```

## How to use Nmap with Metasploit

Integrating nmap with metasploit

### db_nmap

You can run ```db_nmap``` and all the output will be stored in the metasploit database with:
```
hosts
services
```

### You can also import nmap scans

1. Store the file in XML format
```
nmap 192.168.1.1 -oX file.xml
```
or just have all file types with:
```
nmap 192.168.1.1 -oA filename
```

2. Load it into the Metasploit database with the following command
```
db_import /path/to/file.xml
```
## Firewall / IDS Evasion and Spoofing

Use the ```-f``` flag for the requested scan (including ping scans) to use tiny fragmented IP packets. Harder for packet filters
```
nmap 192.168.1.1 -f
```

Use the ```--mtu``` to set your own offset size
```
nmap 192.168.1.1 --mtu 32
```

Use ```-D``` to send scans from spoofed IPs
```
nmap -D 192.168.1.1,192.168.1.2,192.168.1.3 192.168.21.12

nmap -D <spoofed IPs,include yours> <target IP>
```

Use ```-S``` to do spoofed scans
```
nmap -S www.facebook.com www.microsoft.com
#Scan Microsoft from Facebook
```

Use ```--proxies``` to use proxies
```
nmap --proxies http://192.168.1.1:8080,http://192.168.1.2:8080 192.168.1.12

nmap --proxies <http://ip:port, until enough> <target IP>
```

```--data-length``` appends random data to sent packets
```
nmap --data-length 200 192.168.1.1
```

Example IDS Evasion Nmap scan

```
nmap -f -t 0 -n -Pn â€“data-length 200 -D 192.168.1.101,192.168.1.102,192.168.1.103,192.168.1.23 192.168.1.1
```
